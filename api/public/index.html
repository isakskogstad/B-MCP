<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B-MCP - Bolagsverket AI Chat</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .prose h2 { font-size: 1.25rem; font-weight: 700; margin-top: 1.25rem; margin-bottom: 0.75rem; }
    .prose h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
    .prose p { margin-bottom: 0.5rem; }
    .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
    .prose li { margin-bottom: 0.25rem; }
    .prose code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875rem; }
    .prose pre { background: #1f2937; color: #f9fafb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.75rem 0; }
    .prose table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; }
    .prose th, .prose td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
    .prose th { background: #f9fafb; font-weight: 600; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse { animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // Icons as simple SVG components
    const Icons = {
      Send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
      Building: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
      Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
      Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
      Refresh: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
      X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      Loader: () => <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
      Tool: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /></svg>
    };

    function App() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [copiedId, setCopiedId] = useState(null);
      const [model, setModel] = useState('claude-opus-4-5-20251101');
      const [streamingContent, setStreamingContent] = useState('');
      const [toolCalls, setToolCalls] = useState([]);

      const abortControllerRef = useRef(null);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, streamingContent, toolCalls]);

      const models = [
        { id: 'claude-opus-4-5-20251101', name: 'Opus 4.5', desc: 'Smartast', icon: 'üß†' },
        { id: 'claude-sonnet-4-5-20250929', name: 'Sonnet 4.5', desc: 'Balanserad', icon: '‚ö°' },
        { id: 'claude-haiku-4-5-20251001', name: 'Haiku 4.5', desc: 'Snabbast', icon: 'üöÄ' }
      ];

      const examples = [
        'Visa information om Volvo AB (5560360793)',
        'Lista √•rsredovisningar f√∂r Spotify (5567885726)',
        'G√∂r en riskanalys av 5564859921',
        'J√§mf√∂r Volvo (5560360793) med Scania (5562155227)'
      ];

      const sendMessage = async () => {
        if (!input.trim() || isLoading) return;

        const userMessage = {
          role: 'user',
          content: input,
          id: Date.now()
        };

        const newMessages = [...messages, userMessage];
        setMessages(newMessages);
        setInput('');
        setIsLoading(true);
        setStreamingContent('');
        setToolCalls([]);

        abortControllerRef.current = new AbortController();

        try {
          const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: newMessages.map(m => ({
                role: m.role,
                content: m.content
              })),
              model
            }),
            signal: abortControllerRef.current.signal
          });

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let fullContent = '';
          let currentToolCalls = [];

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));

                  if (data.type === 'text') {
                    fullContent += data.content;
                    setStreamingContent(fullContent);
                  } else if (data.type === 'tool_call') {
                    currentToolCalls = [...currentToolCalls, { name: data.name, status: 'running' }];
                    setToolCalls([...currentToolCalls]);
                  } else if (data.type === 'tool_result') {
                    currentToolCalls = currentToolCalls.map(t =>
                      t.name === data.name ? { ...t, status: data.success ? 'success' : 'error', error: data.error } : t
                    );
                    setToolCalls([...currentToolCalls]);
                  } else if (data.type === 'done') {
                    setMessages(prev => [...prev, {
                      role: 'assistant',
                      content: fullContent,
                      toolCalls: currentToolCalls,
                      model,
                      id: Date.now()
                    }]);
                  } else if (data.type === 'error') {
                    throw new Error(data.error);
                  }
                } catch (e) {
                  // Skip invalid JSON
                }
              }
            }
          }

        } catch (err) {
          if (err.name === 'AbortError') {
            if (streamingContent) {
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: streamingContent + '\n\n*[Avbruten]*',
                id: Date.now()
              }]);
            }
          } else {
            setMessages(prev => [...prev, {
              role: 'assistant',
              content: `‚ùå **Fel:** ${err.message}`,
              isError: true,
              id: Date.now()
            }]);
          }
        } finally {
          setIsLoading(false);
          setStreamingContent('');
          setToolCalls([]);
        }
      };

      const stopGeneration = () => {
        abortControllerRef.current?.abort();
      };

      const clearChat = () => {
        setMessages([]);
        setStreamingContent('');
        setToolCalls([]);
      };

      const copyToClipboard = (content, id) => {
        navigator.clipboard.writeText(content);
        setCopiedId(id);
        setTimeout(() => setCopiedId(null), 2000);
      };

      const renderMarkdown = (content) => {
        if (!content) return null;

        return content.split('\n').map((line, i) => {
          if (line.startsWith('## ')) return <h2 key={i} className="text-xl font-bold text-stone-900 mt-5 mb-3">{line.slice(3)}</h2>;
          if (line.startsWith('### ')) return <h3 key={i} className="text-lg font-semibold text-stone-800 mt-4 mb-2">{line.slice(4)}</h3>;
          if (line.startsWith('- ')) return <li key={i} className="text-stone-700 ml-4 mb-1">{renderBold(line.slice(2))}</li>;
          if (line.startsWith('```')) return null;
          if (!line.trim()) return <div key={i} className="h-2" />;
          return <p key={i} className="text-stone-700 leading-relaxed mb-2">{renderBold(line)}</p>;
        });
      };

      const renderBold = (text) => {
        const parts = text.split(/(\*\*.*?\*\*)/g);
        return parts.map((part, i) => {
          if (part.startsWith('**') && part.endsWith('**')) {
            return <strong key={i} className="font-semibold text-stone-900">{part.slice(2, -2)}</strong>;
          }
          return part;
        });
      };

      const currentModel = models.find(m => m.id === model);

      return (
        <div className="h-screen bg-stone-50 flex flex-col">
          {/* Header */}
          <header className="border-b border-stone-200 px-4 py-3 bg-white">
            <div className="max-w-3xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-stone-900 rounded-xl flex items-center justify-center text-white">
                  <Icons.Building />
                </div>
                <div>
                  <h1 className="text-lg font-semibold text-stone-900">B-MCP</h1>
                  <div className="flex items-center gap-2 text-xs text-stone-500">
                    <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full" />
                    <span>{currentModel?.icon} {currentModel?.name}</span>
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                {messages.length > 0 && (
                  <button onClick={clearChat} className="p-2 text-stone-400 hover:text-stone-600 hover:bg-stone-100 rounded-lg">
                    <Icons.Refresh />
                  </button>
                )}
                <button
                  onClick={() => setShowSettings(!showSettings)}
                  className={`p-2 rounded-lg transition-colors ${showSettings ? 'bg-stone-900 text-white' : 'text-stone-400 hover:text-stone-600 hover:bg-stone-100'}`}
                >
                  <Icons.Settings />
                </button>
              </div>
            </div>
          </header>

          {/* Settings Panel */}
          {showSettings && (
            <div className="border-b border-stone-200 bg-white px-4 py-4 overflow-y-auto max-h-[50vh]">
              <div className="max-w-3xl mx-auto space-y-4">
                <div>
                  <label className="block text-sm font-medium text-stone-700 mb-2">Modell</label>
                  <div className="grid grid-cols-3 gap-2">
                    {models.map((m) => (
                      <button
                        key={m.id}
                        onClick={() => setModel(m.id)}
                        className={`p-3 rounded-xl border text-left transition-all ${
                          model === m.id
                            ? 'border-stone-900 bg-stone-900 text-white'
                            : 'border-stone-200 hover:border-stone-300 bg-white'
                        }`}
                      >
                        <div className="flex items-center gap-2">
                          <span className="text-lg">{m.icon}</span>
                          <div>
                            <div className="font-medium text-sm">{m.name}</div>
                            <div className={`text-xs ${model === m.id ? 'text-stone-300' : 'text-stone-500'}`}>{m.desc}</div>
                          </div>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>

                <div className="bg-blue-50 border border-blue-200 rounded-xl p-3">
                  <p className="text-sm text-blue-700">
                    <strong>Bolagsverkets API</strong> - H√§mtar f√∂retagsdata direkt fr√•n officiella k√§llor via MCP-verktyg.
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Chat Area */}
          <main className="flex-1 overflow-auto px-4 py-6">
            <div className="max-w-3xl mx-auto">

              {/* Empty state */}
              {messages.length === 0 && !streamingContent && (
                <div className="text-center py-8">
                  <div className="w-16 h-16 bg-stone-900 rounded-2xl flex items-center justify-center mx-auto mb-6 text-white">
                    <Icons.Building />
                  </div>
                  <h2 className="text-2xl font-bold text-stone-900 mb-2">B-MCP</h2>
                  <p className="text-stone-500 mb-6 max-w-md mx-auto">
                    Fr√•ga om svenska f√∂retag ‚Äì jag h√§mtar data direkt fr√•n Bolagsverkets API.
                  </p>

                  <div className="flex flex-wrap justify-center gap-2 mb-6">
                    <span className="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full">üìã F√∂retagsinfo</span>
                    <span className="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full">üìä √Örsredovisningar</span>
                    <span className="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full">‚ö†Ô∏è Riskanalys</span>
                    <span className="text-xs bg-orange-100 text-orange-700 px-3 py-1 rounded-full">üîÑ J√§mf√∂r f√∂retag</span>
                  </div>

                  <p className="text-sm text-stone-400 mb-3">Prova att fr√•ga:</p>
                  <div className="space-y-2 max-w-md mx-auto">
                    {examples.map((q, i) => (
                      <button
                        key={i}
                        onClick={() => { setInput(q); inputRef.current?.focus(); }}
                        className="w-full text-left text-sm bg-white border border-stone-200 hover:border-stone-300 px-4 py-3 rounded-xl transition-colors"
                      >
                        {q}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Messages */}
              <div className="space-y-4">
                {messages.map((msg) => (
                  <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    {msg.role === 'user' ? (
                      <div className="bg-stone-900 text-white px-4 py-3 rounded-2xl rounded-br-sm max-w-[85%]">
                        {msg.content}
                      </div>
                    ) : (
                      <div className="space-y-2 max-w-[95%] w-full">
                        {/* Tool calls */}
                        {msg.toolCalls?.length > 0 && (
                          <div className="bg-amber-50 border border-amber-200 rounded-xl p-3">
                            <div className="flex items-center gap-2 text-amber-700 text-sm font-medium mb-2">
                              <Icons.Tool /> Verktygsanrop
                            </div>
                            <div className="space-y-1">
                              {msg.toolCalls.map((t, i) => (
                                <div key={i} className="flex items-center gap-2 text-xs">
                                  {t.status === 'success' ? (
                                    <span className="text-emerald-600">‚úì</span>
                                  ) : t.status === 'error' ? (
                                    <span className="text-red-600">‚úó</span>
                                  ) : (
                                    <span className="text-amber-600">‚ãØ</span>
                                  )}
                                  <span className="text-stone-600">{t.name}</span>
                                  {t.error && <span className="text-red-500">{t.error}</span>}
                                </div>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* Content */}
                        <div className={`bg-white border ${msg.isError ? 'border-red-200' : 'border-stone-200'} rounded-2xl rounded-bl-sm p-4 shadow-sm`}>
                          <div className="prose max-w-none">
                            {renderMarkdown(msg.content)}
                          </div>
                        </div>

                        {/* Meta */}
                        <div className="flex items-center gap-3 ml-2 text-xs text-stone-400">
                          <button onClick={() => copyToClipboard(msg.content, msg.id)} className="flex items-center gap-1 hover:text-stone-600">
                            {copiedId === msg.id ? <><Icons.Check /> Kopierat</> : <><Icons.Copy /> Kopiera</>}
                          </button>
                          <span>{models.find(m => m.id === msg.model)?.name || 'Claude'}</span>
                        </div>
                      </div>
                    )}
                  </div>
                ))}

                {/* Streaming */}
                {(streamingContent || toolCalls.length > 0 || isLoading) && (
                  <div className="flex justify-start">
                    <div className="space-y-2 max-w-[95%] w-full">
                      {/* Active tool calls */}
                      {toolCalls.length > 0 && (
                        <div className="bg-amber-50 border border-amber-200 rounded-xl p-3">
                          <div className="flex items-center gap-2 text-amber-700 text-sm font-medium mb-2">
                            <Icons.Tool /> <span className="animate-pulse">H√§mtar data...</span>
                          </div>
                          <div className="space-y-1">
                            {toolCalls.map((t, i) => (
                              <div key={i} className="flex items-center gap-2 text-xs">
                                {t.status === 'success' ? (
                                  <span className="text-emerald-600">‚úì</span>
                                ) : t.status === 'error' ? (
                                  <span className="text-red-600">‚úó</span>
                                ) : (
                                  <span className="text-amber-600 animate-pulse">‚ãØ</span>
                                )}
                                <span className="text-stone-600">{t.name}</span>
                                {t.error && <span className="text-red-500">{t.error}</span>}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {streamingContent && (
                        <div className="bg-white border border-stone-200 rounded-2xl rounded-bl-sm p-4 shadow-sm">
                          <div className="prose max-w-none">
                            {renderMarkdown(streamingContent)}
                          </div>
                          <span className="inline-block w-2 h-4 bg-stone-400 animate-pulse ml-1" />
                        </div>
                      )}

                      {isLoading && !streamingContent && toolCalls.length === 0 && (
                        <div className="bg-white border border-stone-200 rounded-2xl rounded-bl-sm p-4 shadow-sm flex items-center gap-2 text-stone-400">
                          <Icons.Loader /> <span className="text-sm">Ansluter...</span>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              <div ref={messagesEndRef} />
            </div>
          </main>

          {/* Input */}
          <footer className="border-t border-stone-200 px-4 py-4 bg-white">
            <div className="max-w-3xl mx-auto">
              <div className="flex gap-2">
                <input
                  ref={inputRef}
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && sendMessage()}
                  placeholder="St√§ll en fr√•ga om svenska f√∂retag..."
                  disabled={isLoading}
                  className="flex-1 bg-stone-100 border-0 rounded-xl px-4 py-3 text-stone-900 placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-900 disabled:opacity-50"
                />

                {isLoading ? (
                  <button onClick={stopGeneration} className="bg-red-600 hover:bg-red-700 text-white px-5 rounded-xl flex items-center justify-center">
                    <Icons.X />
                  </button>
                ) : (
                  <button
                    onClick={sendMessage}
                    disabled={!input.trim()}
                    className="bg-stone-900 hover:bg-stone-800 disabled:bg-stone-300 text-white px-5 rounded-xl flex items-center justify-center"
                  >
                    <Icons.Send />
                  </button>
                )}
              </div>

              <div className="flex items-center justify-between mt-2 text-xs text-stone-400">
                <span>Enter f√∂r att skicka</span>
                <div className="flex items-center gap-2">
                  <span>{currentModel?.icon} {currentModel?.name}</span>
                </div>
              </div>
            </div>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
